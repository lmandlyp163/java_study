@startuml
skinparam backgroundColor #FFFFFC
title 商品详情页优惠券
actor 骑手 #red

骑手 -> 前端: ① 获取商品优惠券列表
前端 -> API平台 : <B>获取商品优惠券列表</B> \n 1、SKU ID列表 \n 2、门店ID \n 3、用户BmUserID
API平台 -> 骑手商城交易service : 获取商品优惠券列表
骑手商城交易service -> 券平台 : 根据SKU ID列表、门店ID、BmUserId查询有效优惠券
券平台 -> 券平台 : 排序&标记最优优惠券
券平台 --> 骑手商城交易service : 返回可用优惠券列表
note right
结果（需返回平台劵+店铺劵）：
<B>老数据</B>
1、优惠券ID
2、优惠劵名称
3、使用状态
    --0-未使用，1-已使用，2-已过期，3-已冻结，4-已锁定
4、优惠券金额
5、优惠券门槛
6、领取时间
7、领券渠道
8、销售渠道
9、优惠券有效期-开始时间 & 优惠券有效期-结束时间
10、门店id
11、skuids
12、couponStatus 领取状态（本期可能不再使用）
13、领券渠道ID
<B>新数据</B>
1、劵的状态(未使用、已过期、已使用) && 劵的领取状态（可领取、不可领取、已抢光）
      --只要有未使用的优先返回未使用，其次已使用，最后已过期
      --可领取的定义：优惠劵可领时间满足，个人限购满足
      --不可领取定义：时间不满足 或者 个人限购不满足
      --已抢光的定义：总优惠劵不满足
2、劵类型（店铺劵、平台劵（全平台、品类、指定商品））
3、劵对应的内容
4、活动id
5、活动的可领时间范围
6、用户已领券的可用时间范围
    --最后一次领取的时间范围
end note
骑手商城交易service -> 骑手商城交易service : 过滤销售渠道不匹配的

par 店铺劵
骑手商城交易service -> 获取店铺信息 : 获取店铺名称
骑手商城交易service -> 获取店铺信息 : 组织商品信息（spuvo）
note right : 核心保持老逻辑
end

par 平台劵
    else 优惠劵活动优惠券范围为全平台
        骑手商城交易service -> 骑手商城交易service : 新增商品ids扩展字段spuIds&&spuIds为空list
        note right : 注意点（商品ids为空list）
    else 优惠劵活动优惠券范围为后台类目
        骑手商城交易service -> 商品中心 : 根据后台类目ids批量获取类目对应的商品ids，并赋值到新增的扩展字段spuIds
        note right : 商品中心可支持
        商品中心 ->   骑手商城后端: 返回商品spuIds
    else 优惠劵活动优惠券范围为自定义商品id
        骑手商城交易service -> 骑手商城后端 : 获取优惠劵配置内容中的商品ids赋值到新的spuIds字段返回
    骑手商城交易service -> 骑手商城交易service : 组装spuIds
end

骑手商城交易service -> 骑手商城交易service : 对平台劵与店铺劵排序
note right : 已领取平台券>已领取店铺券>未领取平台券>未领取店铺券，同类型按照折扣大小进行排序


骑手商城交易service -> DB : 获取活动对应的配置信息（平台劵场景）
骑手商城交易service -> 骑手商城交易service : 转化出端上的按钮样式
note right : 参考通用判断逻辑
骑手商城交易service -> 骑手商城交易service : 过滤出可领取的或者已领取可使用的返回
骑手商城交易service --> API平台 : 优惠券列表返回
API平台 --> 前端 : 优惠券列表返回


@enduml